<!doctype html public "-//w3c//dtd html 4.1 transitional//en">
<html>
<head>
 <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
 <meta name="Author" content="Rod Elliott - Elliott Sound Products">
 <meta name="keywords" content="audio, project, diy, amp, preamp, distortion, analyzer, analyser, thd, test, circuit, schematic, diagram">
 <meta name="Description" content="ESP Project Pages - Distortion Analyser. Visit my other pages for more audio projects and articles">
 <title>Distortion Analyser</title>
 <link rel="StyleSheet" href="esp.css" type="text/css" media="screen, print">
 <style TYPE="text/css"><!-- td { font-size: 10pt } th { font-size: 10pt } --> </style>
 <link rel="shortcut icon" type="image/ico" href="favicon.ico">
</head>
<body text="#000000" bgcolor="#FFFFFF" link="#0000EE" vlink="#551A8B" alink="#FF0000">
<table width="100%"><tr><td><img SRC="esp.jpg" alt="ESP Logo" height=81 width=215>
<td align="right">

<script type="text/javascript"><!--
google_ad_client = "pub-1947877433449191";
/* 468x60, created 20/08/10 */
google_ad_slot = "7119701939";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

</td></table>

<table WIDTH="100%" BGCOLOR="blue">
<tr><td class="hdrl">&nbsp;Elliott Sound Products</td>
<td ALIGN=RIGHT class="hdrr">Project 52&nbsp;</td>
</tr></table>

<p align="center"><b>Distortion Analyser</b><br />
<small>Rod Elliott (ESP)<br />
Updated 23 Dec 2007</small></p>

<!-- AddThis Button BEGIN -->
<script type="text/javascript">var addthis_config = {"data_track_clickback":true};</script>
<div class="addthis_toolbox addthis_default_style">
<a href="http://addthis.com/bookmark.php?v=250&amp;username=rode" class="addthis_button_compact">Share</a>
<span class="addthis_separator">|</span>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_myspace"></a>
<a class="addthis_button_google"></a>
<a class="addthis_button_twitter"></a>
</div>
<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#username=rode"></script>
<!-- AddThis Button END -->

<hr /><b>Introduction</b>
<p>Total harmonic distortion (THD) measurements are one of the most commonly quoted in audio. Contrary to belief in some circles, these can be very useful if performed properly, and reveal much about the overall performance of an amplifier.

<p>There are a number of ways to measure distortion, none of which is perfect. Probably the best is a spectrum analyser, which shows the individual harmonics
and their amplitudes. These are too expensive for the likes of you and me (well, me, anyway) and the next best thing is featured here.

<p>There are other methods as well, one of which is to subtract the output of an amplifier from the input (with appropriate scaling). When the two signals are exactly equal and opposite they are cancelled out - any signal left is distortion created in the amplifier. This method seems easy, but is not, because there are phase shifts within the amp that can be very difficult to compensate for exactly, and the final accuracy of tuning the parameters - amplitude and phase - must be just as great as with this circuit for a meaningful result.</p>

<hr /><b>Description</b>
<p>The standard tool for measuring THD is a notch filter. This is tuned to reject the fundamental frequency, and any signal that gets through is a combination of the amplifier's noise (including any hum) and the distortion. The distortion shows up as a signal that is harmonically related to the signal fed into the amp, but is not the fundamental. Harmonics occur at double, triple, quadruple (etc) the input frequency. These are referred to as 2nd, 3rd, 4th (etc) harmonics, and are subdivided into odd and even. Even harmonics (2nd, 4th, etc) are claimed to sound better than odd (3rd, 5th, etc), but in reality we don't want any of them.</p>

<center><img SRC="p52-f1.gif" ALT="Figure 1" BORDER=1>
<br /><b><small>Figure 1 - Basic Twin-T Notch Filter</small></b></center>

<p>The filter of Figure 1 is 'normalised' to 1uF and 1k Ohm, giving a frequency of 159Hz. The resistor and capacitor ratios are extraordinarily critical if a deep notch is to be obtained, and this is essential for distortion measurement. This notch filter is called a Twin-T, and works by phase cancellation of the input signal. When the phase shift is exactly +90&deg; and -90&deg; in the two sections, the tuned frequency is completely cancelled, leaving only those signals that are not tuned out. This residual signal represents total harmonic distortion + noise.</p>

<center><img SRC="p52-f2.gif" ALT="Figure 2" BORDER=1>
<br /><b><small>Figure 2 - Frequency Response Of Standard Notch Filter</small></b></center>

<p>The problem with the notch filter shown, is that its attenuation is too high at the 2nd harmonic, and in fact is only acceptable one decade from the fundamental. The example shown has about 0.7dB attenuation at 1.6kHz - a decade from the 159Hz fundamental frequency. This is corrected by using feedback, which tries to get rid of the notch, but is completely unsuccessful, since when properly tuned the notch is infinitely deep.

<p>Too much feedback, and the filter will be untunable because it is too sharp, so a compromise is needed. We need the filter to cause no more than a dB or so of attenuation at double the fundamental frequency (this is one octave), to prevent serious measurement errors of second harmonic distortion.

<p>Figure 3 shows the result when we apply feedback, and the error at one octave is now less than 1dB. This is acceptable for normal measurements, and the resulting error is small, while retaining the ability to tune the filter. Note that although it is tuneable, this filter is still extremely sharp, and unless multi-turn pots are used it will be almost impossible to obtain a good notch. The slightest variation of the input frequency will create a massively high 'distortion' figure. I have found that with very low distortion amps, it is a real battle to measure the distortion whilst trying to keep the filter tuned, because of drift.</p>

<center><img SRC="p52-f3.gif" ALT="Figure 3" BORDER=1>
<br /><b><small>Figure 3 - Frequency Response With Feedback</small></b></center>

<p>This overall characteristic is the desired one, so the final notch filter design is shown in Figure 4, with the feedback applied from the opamp. I have chosen to make the feedback adjustable, so that you can easily modify the characteristics if you want to. This can make it a little easier to tune, since initial tuning can be done with a small amount of feedback, and as the exact frequency is tuned in, the feedback can be increased.

<p>Once upon a time, it was possible to obtain 50k+ 50K+ 25K wirewound pots (I think that was the range) - yes, a triple gang, two separate resistances, wirewound pot! These were especially for just this type of circuit, but I doubt that you will find one any more. The only way that multiple frequencies can be tested is to use a switched selector, and ensure that there is enough range in the tuning pots to make up for all capacitor value errors.

<p>The accuracy of tuning is critical - a 40dB deep notch will show the distortion as 1%, even though it may be much less. A 60dB notch reduces this to 0.1% and so on. For a 100dB notch, you will need all components accurate to within 10ppm (parts per million), or 0.001%. Even a small temperature change can send the meter needle (or oscilloscope trace) straight off the scale. I know this, because it happens every time I try to measure very low distortion levels, and I can't even get to 0.001% on my meter because my oscillator has more distortion than that.</p>

<center><img SRC="p52-f4.gif" ALT="Figure 4" BORDER=1>
<br /><b><small>Figure 4 - The Variable Q Tuneable Notch Filter</small></b></center>

<p>To change ranges, we must vary either the resistance or capacitance (or both). Figure 5 shows the range switching. To try to keep the unit reasonably versatile, I have included two switches. SW1 gives 20, 200 and 2kHz ranges by changing capacitor values. SW2 gives the standard 1, 2, 5 sequence common in oscilloscopes. This combination allows the following frequencies to be tested ...</p>

<center><table width="33%" BORDER="1">
<tr><td><b>Range 1 (SW1)</b></td><td><b>Range 2 (SW2)</b></td><td><b>Frequency</b></td></tr>
<tr><td>20</td><td>x1</td><td>20Hz</td></tr>
<tr><td>20</td><td>x2</td><td>40Hz</td></tr>
<tr><td>20</td><td>x5</td><td>100Hz</td></tr>
<tr><td>200</td><td>x1</td><td>200Hz</td></tr>
<tr><td>200</td><td>x2</td><td>500Hz</td></tr>
<tr><td>200</td><td>x5</td><td>1kHz</td></tr>
<tr><td>2k</td><td>x1</td><td>2kHz</td></tr>
<tr><td>2k</td><td>x2</td><td>4kHz</td></tr>
<tr><td>2k</td><td>x5</td><td>10kHz</td></tr>

<caption ALIGN=BOTTOM><b><small>Table 1 - Range Switching</small></b></caption>
</table></center>

<p>The notch frequency is determined by</p>

<blockquote>
	<b>f<sub>o</sub> = 1 / ( 2 * &pi; * R1 * C1 )</b><br />
	Resistor values are exactly R1 = R2, R3 = 0.5 * R1<br />
	Capacitor values are exactly C1 = C2, C3 = 2 * C1
</blockquote>

<p>The tuning requires that the ratios are exactly tuned - absolute values are not as important, but must be stable. To be able to tune the notch precisely, we will use pots in series with two of the resistors, R1 and R3. The range of the pots will vary depending on the resistance that is switched into the circuit, and even with multi-turn pots it is useful to have two in series, one with a lower resistance than the other. This is shown in Figure 5.

<p>It is essential to make sure that the pots have enough range to compensate for the tolerance of the capacitors, and some care is needed to keep wiring capacitance to a minimum, especially for the highest frequency range. To this end, I suggest that all tuning components are wired directly to the switches and pots, and that wiring is done with solid tinned copper wire. All wiring can be made self supporting, and will exhibit very low capacitance.</p>

<center><img SRC="p52-f5.gif" ALT="Figure 5" BORDER=1>
<br /><b><small>Figure 5 - Input Level Control And Range Switching</small></b></center>

<p>The range switching simply connects different resistors and / or capacitors into the circuit. A problem is that when resistances are changed, the sensitivity of the tuning pots also changes. This is unavoidable unless you can get odd value triple-gang pots (Do you feel lucky? - If you find them, buy a lottery ticket !!). VR4 and VR6 should be multi-turn - you can get geared pot drives to use standard pots if multiturn units are unavailable.

<p>The values and exact design frequencies are shown in Table 2. To make the C3.x values, parallel two C1.x value caps, and if possible use a capacitance meter to match all capacitors to within 1%. Standard tolerances will affect the centre frequencies. Resistors must be metal film, 1% tolerance. The values of R2.x and R3.x are lower than expected, because I have taken the mid resistance of the two series pots into consideration. Note that some of the resistors require 2 components in series to get the desired resistance.</p>

<center><table width="66%" BORDER="1">
<tr><td><b>Frequency</b></td><td><b>C1.x C2.x</b></td><td><b>C3.x</b></td><td><b>R1.x</b></td>
<td><b>R2.x</b></td><td><b>R3.x</b></td></tr>
<tr><td>19.4 Hz</td><td>100nF</td><td>200nF</td><td>82k Ohm</td><td>75k + 4.3k</td><td>39k + 1k</td></tr>
<tr><td>40.8 Hz</td><td>100nF</td><td>200nF</td><td>39k Ohm</td><td>36k</td><td>18k + 390 Ohm</td></tr>
<tr><td>99.5 Hz</td><td>100nF</td><td>200nF</td><td>16k Ohm</td><td>13k</td><td>6.8k + 100 Ohm</td></tr>
<tr><td>194 Hz</td><td>10nF</td><td>20nF</td><td>82k Ohm</td><td>75k + 4.3k</td><td>39k + 1k</td></tr>
<tr><td>408 Hz</td><td>10nF</td><td>20nF</td><td>39k Ohm</td><td>36k</td><td>18k + 390 Ohm</td></tr>
<tr><td>995 Hz</td><td>10nF</td><td>20nF</td><td>16k Ohm</td><td>13k</td><td>6.8k + 100 Ohm</td></tr>
<tr><td>1.94 kHz</td><td>1 nF</td><td>2nF</td><td>82k Ohm</td><td>75k + 4.3k</td><td>39k + 1k</td></tr>
<tr><td>4.08 kHz</td><td>1 nF</td><td>2nF</td><td>39k Ohm</td><td>36k</td><td>18k + 390 Ohm</td></tr>
<tr><td>9.95 kHz</td><td>1 nF</td><td>2nF</td><td>16k Ohm</td><td>13k</td><td>6.8k + 100 Ohm</td></tr>

<caption ALIGN=BOTTOM><b><small>Table 2 - Resistor and Capacitor Values</small></b></caption>
</table></center>

<p>There are a couple of things to be aware of with this circuit. Firstly, the input impedance is quite low, and use of a buffer is not recommended because this will introduce additional noise and distortion. The opamps used for the feedback should be the best you can get hold of. The Burr-Brown OPA2604 is an excellent choice, with 0.0003 distortion and low noise. Other devices that will be suitable include the LM833 or the venerable NE5532.

<p>To allow power amps to be tested, an input level control is needed, and this is also used for calibration. The control ideally should be a wirewound device, since power dissipation could be quite high, and wirewound pots add less noise than carbon.

<p>The ideal measuring meter is an oscilloscope, but a millivoltmeter may be used. Without the oscilloscope you will be unable to see the 'quality' of the distortion components, but use of an amplifier will allow you to listen to the residual - make sure that you have a limiter circuit on the amp, or a slight bump of the oscillator frequency control will blow your head off! A suitable limiter is published as Project 53.

<p>The final measurement will include the distortion from the audio oscillator, and it is likely that this will be greater than that of many amps. It is not really possible to tell you how you can subtract this from the measured distortion, since the distortion waveform has a huge influence over the result. The distortion waveform is very important - a low average level spiky waveform (typical of crossover distortion) will sound much worse than an apparently higher level of "clean" 3rd harmonic distortion
from a well designed push-pull amplifier stage.</p>

<ul>
	<li>To measure the distortion, set Q to minimum, all tuning pots to the mid position, and frequency to something well away (> one decade) from
	the intended measurement frequency. With the input level at minimum, apply the signal to be measured. The voltage must be greater than 3V
	RMS.</li>
	<li>If you are using a millivoltmeter (not digital!), set it to the 3V range, and advance the input level until the meter reads full scale. Set
	the frequency range controls to the test frequency, and reduce the Q control to about half or less.</li>
	<li>Carefully adjust the oscillator frequency, then the fine tuning controls (they are interactive) until the minimum possible voltage reading
	is shown, adjusting the range on the millivoltmeter as you get lower readings. Advance the Q control and repeat until Q is at maximum, and you
	have the minimum voltage reading. In some cases you will need to re-adjust the oscillator frequency slightly to be able to obtain a null in the
	meter reading.</li>
	<li>Make sure that the input level control is not changed during the measurement, as the resistance affects the notch filter tuning, and you
	will have to re-tune the filter.</li>
</ul>

<p>If you were to obtain a final reading of 7mV, you can now determine the distortion + noise</p>

<blockquote><b>THD% = ( V2 / V1 ) x 100</b> &nbsp; &nbsp; Where V1 is the initial voltage and V2 is the lowest reading
<br />THD  = ( 0.007 / 3 ) x 100 = 0.23%</blockquote>

<table WIDTH="100%">
<tr><td VALIGN=TOP><img SRC="note.gif" ALT="NOTE"></td>
<td><big>Remember that if you apply too much signal to the input, you will destroy the opamp. The use of protection diodes is not an option (IMHO), as this will introduce distortion, making your measurements useless. The distortion introduced by the analyser will exceed that of a good amplifier. This is unhelpful!</big></td>
</tr></table>

<p>The distortion meter circuit can be simplified. For example, you may feel that there are more ranges than you need, and these can be adapted for your needs. You might even think that a single range is sufficient, and for many basic tests this is OK. Naturally, you will be unaware of distortion that may become apparent only at low or high frequencies - but I shall leave this up to you.</p>
<p>The traces below show the fundamental (green) at 705mV, some deliberately introduced odd-order harmonic distortion (red) and even-order distortion (blue). Note that there is no evidence whatsoever of the original 159Hz fundamental - the notch filter has removed it completely. Anything left over has been added to the original signal, and is therefore distortion.</p>

<center><img SRC="p52-f6.gif" ALT="Figure 6" BORDER=1>
<br /><b><small>Figure 6 - Fundamental, Plus Distortion Waveforms</small></b></center>

<p>The distortion voltages were amplified by 100 times for clarity. The odd-order distortion measures 40.81mV (408.1uV), and even-order distortion was 33.05mV (330.5uV) - remember, the displayed and measured distortion was amplified by 100. The discontinuity at the beginning of the waveforms (which start at 12.5ms rather than zero) is because of the notch filter. Because it has a high Q, the waveform suffers from considerable transient distortion, and the last remainder is visible on the trace.

<p>Using the formula above, distortion can be calculated ...</p>

<blockquote>
	THD% = ( 408.1uV / 705mV ) x 100 = 0.058% &nbsp; &nbsp; (odd-order)<br />
	THD% = ( 330.5uV / 705mV ) x 100 = 0.047% &nbsp; &nbsp; (even-order)
</blockquote>

<p>Distortion was created by the simple circuit shown below. Since the graph shown is from a simulator, it was necessary to add distortion because the simulator's output waveform is a perfect sinewave, and has zero distortion.</p>

<center><img SRC="p52-f7.gif" ALT="Figure 7" BORDER=1>
<br /><b><small>Figure 7 - Distortion Generator</small></b></center>

<p>With an applied signal of 1V peak (707mV RMS), the distortion added is quite small. This is especially true when you consider that the signal is limited by a 10 ohm resistor, and the diode distortion is applied via the 1k resistor. It is probable that this amount of distortion would be inaudible on a sinewave, and it will definitely be inaudible with a music signal (of the same peak amplitude of course).</p>

<hr />
<center>&nbsp;
<script type="text/javascript"><!--
google_ad_client = "pub-1947877433449191";
/* 468x60, created 20/08/10 */
google_ad_slot = "7119701939";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</center>

<hr /><a href="projects.htm" OnMouseOver="document.b1.src='arrow.gif';" OnMouseOut="document.b1.src='a1.gif';">
<img src="a1.gif" name="b1" alt="Index" border=0 height=24 width=40></a><b>Projects Index</b>
<br /><a href="index2.html" OnMouseOver="document.b3.src='a.gif';" OnMouseOut="document.b3.src='a1.gif';">
<img src="a1.gif" name="b3" alt="ESP Home" border=0></a><b>Main Index</b><br /><br />

<table BORDER BGCOLOR="black">
<tr><td class="t-wht"><a id="copyright"></a><b>Copyright Notice.</b> This article, including but not limited to all text and diagrams, is the intellectual property of Rod Elliott, and is Copyright (c) 1999. Reproduction or re-publication by any means whatsoever, whether electronic, mechanical or electro- mechanical, is strictly prohibited under International Copyright laws. The author (Rod Elliott) grants the reader the right to use this information for personal use only, and further allows that one (1) copy may be made for reference while constructing the project. Commercial use is prohibited without express written authorisation from Rod Elliott.</td></tr>
</table>
<div class="t-sml">Page Created and Copyright (c) 12 Feb 2000./ Updated 23 Dec 2007 - added figures 6 and 7 and accompanying text.</div>
</body>
</html>
